<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMJ ERP | Exchange Bill</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/print.css" media="print">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .exchange-rules {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .exchange-rules ul {
            margin: 10px 0 0 20px;
        }
        
        .exchange-rules li {
            margin-bottom: 5px;
        }
        
        .item-tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 20px;
        }
        
        .item-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .item-tab.active {
            border-bottom-color: #D4AF37;
            color: #D4AF37;
        }
        
        .item-form {
            display: none;
        }
        
        .item-form.active {
            display: block;
        }
        
        .exchange-summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        
        .summary-card.total {
            background: #D4AF37;
            color: white;
            border-color: #D4AF37;
        }
        
        .summary-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .summary-card.total .summary-label,
        .summary-card.total .summary-value {
            color: white;
        }
        
        .balance-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            margin: 20px 0;
        }
        
        .balance-amount {
            font-size: 36px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
        }
        
        .balance-amount.payable {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }
        
        .balance-amount.refundable {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }
        
        .balance-amount.settled {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #17a2b8;
        }
        
        .exchange-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        @media (max-width: 1200px) {
            .exchange-summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .exchange-summary-grid {
                grid-template-columns: 1fr;
            }
            
            .item-tabs {
                flex-direction: column;
            }
            
            .item-tab {
                width: 100%;
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo-section">
                <div class="logo">SMJ</div>
                <div class="brand-info">
                    <h1>Exchange Bill - Shree Mahakaleshwar Jewellers</h1>
                    <p class="tagline">Wear With Cheer</p>
                </div>
            </div>
            <div class="user-info">
                <button class="btn-secondary" onclick="window.location.href='index.html'">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </button>
                <button class="btn-logout" onclick="auth.logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="sidebar">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="billing.html" class="nav-link">
                        <i class="fas fa-file-invoice"></i> New Bill
                    </a>
                </li>
                <li class="nav-item active">
                    <a href="exchange.html" class="nav-link">
                        <i class="fas fa-exchange-alt"></i> Exchange
                    </a>
                </li>
                <li class="nav-item">
                    <a href="stocks.html" class="nav-link">
                        <i class="fas fa-boxes"></i> Stock
                    </a>
                </li>
                <li class="nav-item">
                    <a href="reports.html" class="nav-link">
                        <i class="fas fa-chart-bar"></i> Reports
                    </a>
                </li>
                <li class="nav-item">
                    <a href="admin.html" class="nav-link">
                        <i class="fas fa-cog"></i> Admin
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="billing-container">
                <!-- Exchange Rules -->
                <div class="exchange-rules">
                    <h4><i class="fas fa-exclamation-circle"></i> Exchange Business Rules</h4>
                    <ul>
                        <li><strong>3% Deduction:</strong> Automatic 3% deduction on exchange value</li>
                        <li><strong>GST:</strong> 3% GST on metal value only (applied in billing)</li>
                        <li><strong>Wastage:</strong> Typically 2-5% for old jewellery</li>
                        <li><strong>Melting Charges:</strong> Apply if old jewellery needs melting</li>
                        <li><strong>Market Rates:</strong> Use current market rates for valuation</li>
                    </ul>
                </div>

                <!-- Customer Details -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-user"></i> Customer Details</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customerName" class="required">Customer Name</label>
                                <input type="text" id="customerName" placeholder="Enter customer name" required>
                            </div>
                            <div class="form-group">
                                <label for="customerPhone" class="required">Phone Number</label>
                                <input type="tel" id="customerPhone" placeholder="10-digit phone number" pattern="[0-9]{10}" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customerAddress">Address</label>
                                <textarea id="customerAddress" rows="2" placeholder="Enter customer address"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Item Type Tabs -->
                <div class="item-tabs">
                    <button class="item-tab active" onclick="showItemForm('old')">
                        <i class="fas fa-box"></i> Old Items (Exchange)
                    </button>
                    <button class="item-tab" onclick="showItemForm('new')">
                        <i class="fas fa-gem"></i> New Items (Purchase)
                    </button>
                </div>

                <!-- Old Item Form -->
                <div class="card item-form active" id="oldItemForm">
                    <div class="card-header">
                        <h3><i class="fas fa-box"></i> Old Item Details (For Exchange)</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="oldProductName" class="required">Product Name</label>
                                <input type="text" id="oldProductName" placeholder="e.g., Old Gold Necklace" required>
                            </div>
                            <div class="form-group">
                                <label for="oldUnit" class="required">Unit</label>
                                <select id="oldUnit" required>
                                    <option value="">Select Unit</option>
                                    <option value="PCS">PCS (Pieces)</option>
                                    <option value="GM">GM (Grams)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="oldQuantity" class="required">Quantity</label>
                                <input type="number" id="oldQuantity" min="1" step="1" value="1" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="oldGrossWeight" class="required">Gross Weight (g)</label>
                                <input type="number" id="oldGrossWeight" min="0" step="0.001" placeholder="0.000" required>
                            </div>
                            <div class="form-group">
                                <label for="oldLessWeight">Less Weight (g)</label>
                                <input type="number" id="oldLessWeight" min="0" step="0.001" placeholder="0.000">
                            </div>
                            <div class="form-group">
                                <label for="oldNetWeight">Net Weight (g)</label>
                                <input type="number" id="oldNetWeight" readonly>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="oldMetalType" class="required">Metal Type</label>
                                <select id="oldMetalType" required>
                                    <option value="">Select Metal</option>
                                    <!-- Dynamically populated -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="oldPurity" class="required">Purity</label>
                                <select id="oldPurity" required disabled>
                                    <option value="">Select Purity</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="oldMarketRate" class="required">Market Rate (₹/g)</label>
                                <input type="number" id="oldMarketRate" min="0" step="0.01" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="oldWastage">Wastage (%)</label>
                                <input type="number" id="oldWastage" min="0" step="0.01" value="2">
                            </div>
                            <div class="form-group">
                                <label for="oldMeltingCharges">Melting Charges (₹)</label>
                                <input type="number" id="oldMeltingCharges" min="0" step="0.01" value="0">
                            </div>
                            <div class="form-group">
                                <label for="oldOtherCharges">Other Charges (₹)</label>
                                <input type="number" id="oldOtherCharges" min="0" step="0.01" value="0">
                            </div>
                        </div>

                        <div class="exchange-info">
                            <p><i class="fas fa-info-circle"></i> Exchange Value = (Net Weight × Market Rate) - 3% - Wastage - Melting Charges</p>
                        </div>

                        <div class="calculation-summary">
                            <div class="calc-item">
                                <span>Metal Value:</span>
                                <span id="oldMetalValueDisplay">₹0.00</span>
                            </div>
                            <div class="calc-item">
                                <span>Exchange Deduction (-3%):</span>
                                <span id="oldExchangeDeductionDisplay" class="text-danger">-₹0.00</span>
                            </div>
                            <div class="calc-item">
                                <span>Wastage Deduction:</span>
                                <span id="oldWastageDisplay" class="text-danger">-₹0.00</span>
                            </div>
                            <div class="calc-item">
                                <span>Melting Charges:</span>
                                <span id="oldMeltingChargesDisplay">₹0.00</span>
                            </div>
                            <div class="calc-item total">
                                <span>Exchange Value:</span>
                                <span id="oldTotalDisplay">₹0.00</span>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button class="btn-secondary" id="clearOldItemBtn">
                                <i class="fas fa-times"></i> Clear
                            </button>
                            <button class="btn-primary" id="addOldItemBtn">
                                <i class="fas fa-plus"></i> Add to Exchange
                            </button>
                        </div>
                    </div>
                </div>

                <!-- New Item Form -->
                <div class="card item-form" id="newItemForm">
                    <div class="card-header">
                        <h3><i class="fas fa-gem"></i> New Item Details (To Purchase)</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newProductName" class="required">Product Name</label>
                                <input type="text" id="newProductName" placeholder="e.g., New Gold Ring" required>
                            </div>
                            <div class="form-group">
                                <label for="newUnit" class="required">Unit</label>
                                <select id="newUnit" required>
                                    <option value="">Select Unit</option>
                                    <option value="PCS">PCS (Pieces)</option>
                                    <option value="GM">GM (Grams)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newQuantity" class="required">Quantity</label>
                                <input type="number" id="newQuantity" min="1" step="1" value="1" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="newGrossWeight" class="required">Gross Weight (g)</label>
                                <input type="number" id="newGrossWeight" min="0" step="0.001" placeholder="0.000" required>
                            </div>
                            <div class="form-group">
                                <label for="newLessWeight">Less Weight (g)</label>
                                <input type="number" id="newLessWeight" min="0" step="0.001" placeholder="0.000">
                            </div>
                            <div class="form-group">
                                <label for="newNetWeight">Net Weight (g)</label>
                                <input type="number" id="newNetWeight" readonly>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="newMetalType" class="required">Metal Type</label>
                                <select id="newMetalType" required>
                                    <option value="">Select Metal</option>
                                    <!-- Dynamically populated -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newPurity" class="required">Purity</label>
                                <select id="newPurity" required disabled>
                                    <option value="">Select Purity</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newRate" class="required">Rate (₹/g)</label>
                                <input type="number" id="newRate" min="0" step="0.01" required readonly>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="newMakingChargeType" class="required">Making Charge Type</label>
                                <select id="newMakingChargeType" required>
                                    <option value="FIX">FIX (₹)</option>
                                    <option value="%" selected>% (Percentage)</option>
                                    <option value="GRM">GRM (₹ per gram)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newMakingChargeValue" class="required">Making Charge Value</label>
                                <input type="number" id="newMakingChargeValue" min="0" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="newDiscountOnMaking">Discount on Making (₹)</label>
                                <input type="number" id="newDiscountOnMaking" min="0" step="0.01" value="0">
                            </div>
                        </div>

                        <div class="calculation-summary">
                            <div class="calc-item">
                                <span>Metal Value:</span>
                                <span id="newMetalValueDisplay">₹0.00</span>
                            </div>
                            <div class="calc-item">
                                <span>Making Charge:</span>
                                <span id="newMakingChargeDisplay">₹0.00</span>
                            </div>
                            <div class="calc-item total">
                                <span>Item Total:</span>
                                <span id="newTotalDisplay">₹0.00</span>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button class="btn-secondary" id="clearNewItemBtn">
                                <i class="fas fa-times"></i> Clear
                            </button>
                            <button class="btn-primary" id="addNewItemBtn">
                                <i class="fas fa-plus"></i> Add to Purchase
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Items Summary Tables -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-list"></i> Exchange Items Summary</h3>
                        <span class="badge" id="exchangeItemCount">0 items</span>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="data-table" id="exchangeItemsTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Product</th>
                                        <th>Type</th>
                                        <th>Metal/Purity</th>
                                        <th>Weight</th>
                                        <th>Rate</th>
                                        <th>Value</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="exchangeItemsTableBody">
                                    <!-- Items will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Exchange Summary -->
                <div class="exchange-summary-grid" id="exchangeSummarySection">
                    <div class="summary-card">
                        <div class="summary-label">Old Items Total</div>
                        <div class="summary-value" id="oldItemsTotal">₹0.00</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">New Items Total</div>
                        <div class="summary-value" id="newItemsTotal">₹0.00</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Exchange Value</div>
                        <div class="summary-value" id="exchangeValueTotal">₹0.00</div>
                    </div>
                    <div class="summary-card total">
                        <div class="summary-label">Balance</div>
                        <div class="summary-value" id="balanceTotal">₹0.00</div>
                    </div>
                </div>

                <!-- Balance Section -->
                <div class="balance-section" id="balanceSection" style="display: none;">
                    <h4 class="text-center">Final Settlement</h4>
                    <div class="balance-amount" id="balanceAmount">
                        ₹0.00
                    </div>
                    <p class="text-center" id="balanceLabel">
                        <!-- Will be populated dynamically -->
                    </p>
                </div>

                <!-- GST Section -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-receipt"></i> GST Details (For New Items)</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cgst">CGST (₹)</label>
                                <input type="number" id="cgst" min="0" step="0.01" value="0">
                            </div>
                            <div class="form-group">
                                <label for="sgst">SGST (₹)</label>
                                <input type="number" id="sgst" min="0" step="0.01" value="0">
                            </div>
                            <div class="form-group">
                                <label for="igst">IGST (₹)</label>
                                <input type="number" id="igst" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        <div class="gst-info">
                            <p><strong>Note:</strong> GST is applicable only on new purchase items.</p>
                            <p>Total GST: <span id="totalGSTDisplay">₹0.00</span></p>
                        </div>
                    </div>
                </div>

                <!-- Payment & Final Actions -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-money-bill-wave"></i> Payment Details</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="paymentMethod" class="required">Payment Method</label>
                                <select id="paymentMethod" required>
                                    <option value="cash">Cash</option>
                                    <option value="card">Card</option>
                                    <option value="upi">UPI</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="paymentStatus" class="required">Payment Status</label>
                                <select id="paymentStatus" required>
                                    <option value="paid">Paid</option>
                                    <option value="pending">Pending</option>
                                    <option value="partial">Partial</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="exchangeNotes">Exchange Notes</label>
                                <textarea id="exchangeNotes" rows="3" placeholder="Additional notes about the exchange transaction..."></textarea>
                            </div>
                        </div>

                        <!-- Final Actions -->
                        <div class="final-actions">
                            <button class="btn-secondary" id="clearExchangeBtn">
                                <i class="fas fa-trash"></i> Clear All
                            </button>
                            <button class="btn-warning" id="calculateExchangeBtn">
                                <i class="fas fa-calculator"></i> Calculate Exchange
                            </button>
                            <button class="btn-success" id="completeExchangeBtn" disabled>
                                <i class="fas fa-exchange-alt"></i> Complete Exchange
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>Shree Mahakaleshwar Jewellers Exchange System | Fixed 3% Exchange Deduction | GST on New Items Only</p>
        </footer>
    </div>

    <!-- Exchange Success Modal -->
    <div class="modal" id="exchangeSuccessModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Exchange Completed Successfully!</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="success-message">
                    <i class="fas fa-check-circle"></i>
                    <p>Exchange transaction has been completed and bill is generated.</p>
                    <p><strong>Bill Number:</strong> <span id="generatedExchangeBillNumber"></span></p>
                    <p><strong>Balance Amount:</strong> <span id="generatedBalanceAmount"></span></p>
                    <p><strong>Status:</strong> <span id="generatedBalanceStatus"></span></p>
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="printExchangeBill()">
                        <i class="fas fa-print"></i> Print Bill
                    </button>
                    <button class="btn-primary" onclick="downloadExchangePDF()">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                    <button class="btn-success" onclick="sendExchangeWhatsApp()">
                        <i class="fab fa-whatsapp"></i> Send via WhatsApp
                    </button>
                    <button class="btn-info" onclick="window.location.href='exchange.html'">
                        <i class="fas fa-redo"></i> New Exchange
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/exchange.js"></script>
</body>
</html>
